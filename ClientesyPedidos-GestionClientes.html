<html>
    <head>
        <title></title>
        <meta charset="UTF-8">
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="estilos/pantallasCultivos.css">
        <script type="text/javascript" src="scripts/sesion.js"></script>
        <style>
            .edit-icon {
                position: absolute; 
                top: 10px; 
                right: 10px;
                margin-bottom: 0;
            }
            .item-cliente, .item-pedido {
                border: 1px solid #D9D9D9;
                padding: 15px;
                padding-right: 50px; 
                border-radius: 10px;
                margin-bottom: 15px;
                font-family: "Inter", sans-serif;
                position: relative; 
            }
            .cliente-nombre, .pedido-nombre {
                font-size: 18px;
                font-weight: 600;
                margin: 0 0 5px 0;
            }
            .cliente-info, .pedido-datos {
                font-size: 14px;
                color: #8B8383;
                display: flex;
                align-items: center;
                margin-bottom: 10px;
            }
            .icon-info {
                font-size: 16px;
                margin-right: 3px;
            }
            .cliente-datos {
                display: flex;
                justify-content: space-between;
                font-size: 14px;
            }
            .total-compra {
                font-weight: 200;
                color: #4C4C4C; 
            }
            .item-pedido .pedido-producto {
                font-size: 14px;
                color: #4C4C4C;
                margin: 0 0 8px 0;
            }
            .item-pedido .pedido-datos {
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                gap: 3px;
                margin-bottom: 0;
            }
            .item-pedido .pedido-total {
                position: absolute;
                top: 50px;
                right: 170px;
                font-weight: 400;
                font-size: 16px;
            }
            .estado {
                position: absolute;
                top: 50px;
                right: 50px;
                padding: 3px 10px;
                border-radius: 5px;
                font-weight: bold;
                font-size: 12px;
            }
            .entregado {
                background-color: #e0f2e0;
                color: #346E19; 
            }
            .no-entregado {
                background-color: #fcebeb;
                color: #d32f2f;
            }
        </style>
    </head>
    <body onload="inicio()">
        <h1>Gestión de Clientes</h1>
        <h2>Seguimiento de clientes, pedidos y ventas</h2>
        <div class="contenedor">
            <div class="cuadros">
                <p style="font-weight: bold;">Total Ingresos</p>
                <text style="color:#316C1B; font-size: 25px; margin-top: 30px;" id="Ingresos">$0</text><br>
                <text style="color:#8B8383; font-size: 14px; margin-top: -15px;">Mes actual</text>
            </div>
            <div class="cuadros">
                <p style="font-weight: bold;">Total Gastos</p>
                <text style="color:#C51B1B; font-size: 25px; margin-top: 30px;" id="Gastos">$0</text><br>
                <text style="color:#8B8383; font-size: 14px; margin-top: -15px;">Mes actual</text>
            </div>
            <div class="cuadros">
                <p style="font-weight: bold;">Balance</p>
                <text style="color:#316C1B; font-size: 25px; margin-top: 30px;" id="Balance">$0</text><br>
                <text style="color:#8B8383; font-size: 14px; margin-top: -15px;">Resultado Neto</text>
            </div>
        </div>
        <div style="display: flex; gap: 40px; margin-left: 20px; margin-top: 30px; width: 95%;">
            <div style="flex: 1;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="font-family: 'Inter', sans-serif; font-size: 18px; display: flex; align-items: center; gap: 5px; font-weight: 600;"><span class="material-icons" style="font-size: 20px;"><img src="iconos/revisar.png" alt="clientes" style="width: 14px; height: 14;"></span> Lista de Clientes</h3>
                    <button onclick="window.location.href = 'ClientesyPedidos-FormularioClientes.html'" style="background-color: #346E19; color: white; border: none; padding: 8px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px;"><span class="material-icons" style="font-size: 18px;"><img src="iconos/anadir.png" alt="clientes" style="width: 14px; height: 14;"></span> Agregar</button>
                </div>
                <div id="clientes">

                </div>
                
                
            </div>
            
            <div style="flex: 1;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="font-family: 'Inter', sans-serif; font-size: 18px; display: flex; align-items: center; gap: 5px; font-weight: 600;"><span class="material-icons" style="font-size: 20px;"><img src="iconos/envio.png" alt="clientes" style="width: 14px; height: 14;"></span> Pedidos</h3>
                    <button onclick="window.location.href = 'ClientesyPedidos-FormularioPedido.html'" style="background-color: #346E19; color: white; border: none; padding: 8px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px;"><span class="material-icons" style="font-size: 18px;"><img src="iconos/anadir.png" alt="clientes" style="width: 14px; height: 14;"></span> Nuevo Pedido</button>
                </div>

                <div id="pedidos">

                </div>
            </div>
    </div>

    <div class="contenido">
        <h3 style="font-family: 'Inter', sans-serif; font-size: 18px; font-weight: 600; margin-left: 10px;">Historial de Ventas</h3>
        
        <div class="arriba" style="display: none;">
            <text>Filtros:</text>
            <select>
                <option>Cliente</option>
            </select>
            <select>
                <option>Producto</option>
            </select>
            <input type="date" value="dd/mm/aaaa">
            <button class="filtrar">Filtrar</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Cliente</th>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Fecha Pedido</th>
                    <th>Estado</th>
                    <th>Monto</th>
                </tr>
            </thead>
            <tbody id="tabla-pedidos">
            </tbody>
        </table>

        </div>
    </body>
    <script>
        function inicio(){
            fetch("php/clientesypedidos/SelectClientes.php")
            .then(res => res.json())
            .then(datos => {
                const cont = document.getElementById("clientes");
                cont.innerHTML = "";
                datos.forEach(cliente => {
                    const item = document.createElement('div');
                    item.className = 'item-cliente';
                    item.innerHTML = `
                        <p class="cliente-nombre">${cliente.NOMBRE}</p>
                        <div class="cliente-info">
                            <span class="icon-info"><img src="iconos/telefono.png" style="width:14px;height:14px;"></span> ${cliente.TELEFONO}
                            <span class="icon-info" style="margin-left:10px;"><img src="iconos/sobre.png" style="width:14px;height:14px;"></span> ${cliente.CORREO}
                        </div>
                    `;
                    cont.appendChild(item);

                    fetch("php/clientesypedidos/SelectPedidoCliente.php?id=" + encodeURIComponent(cliente.CVE_COMPRADOR))
                    .then(res2 => res2.json())
                    .then(datos2 => {
                        if (datos2.length) {
                            datos2.forEach(pedido => {
                                const d = document.createElement('div');
                                d.className = 'cliente-datos';
                                d.innerHTML = `<span>Última compra: ${pedido.FECHAPEDIDO}</span>
                                            <span class="total-compra">Total: $${pedido.TOTAL}</span>`;
                                item.appendChild(d);
                            });
                        } else {
                            const d = document.createElement('div');
                            d.className = 'cliente-datos';
                            d.textContent = 'No hay pedidos';
                            item.appendChild(d);
                        }
                        const btn = document.createElement('button');
                        btn.className = 'Boton-icono edit-icon';
                        btn.innerHTML = `<img src="iconos/editar.png" style="width:14px;height:14px;">`;
                        item.appendChild(btn);
                    })
                });
            });
            fetch("php/clientesypedidos/SelectPedidos.php")
                .then(res => res.json())
                .then(data => {
                    let div = document.getElementById("pedidos");
                    div.innerHTML = "";
                    data.forEach(pedido => {
                        div.innerHTML += `
                            <div class="item-pedido">
                                <p class="pedido-nombre">Pedido No ${pedido.CVE_PEDIDO}</p>
                                <p class="pedido-producto">${pedido.NOMBRE} ${pedido.CANTIDAD} ${pedido.UNIDAD}</p>
                                <div class="pedido-datos">
                                    <span>Pedido: ${pedido.FECHAPEDIDO}</span> 
                                </div>
                                <span class="estado">${pedido.ENTREGADO}</span>
                                <span class="pedido-total">Total: $${pedido.TOTAL}</span>
                                <button class="Boton-icono edit-icon">
                                    <img src="iconos/editar.png" alt="clientes" style="width: 14px; height: 14;">
                                </button>
                            </div>
                        `;
                    });
                    const estados = document.querySelectorAll('#pedidos .estado');
                    estados.forEach(s => {
                        const text = s.textContent.trim();
                        if (text === 'Entregado') {
                            s.classList.add('entregado');
                        } else {
                            s.classList.add('no-entregado');
                        }
                    });
                });
            fetch("php/clientesypedidos/SelectPedidos2.php")
                .then(res => res.json())
                .then(data => {
                    let table = document.getElementById("tabla-pedidos");
                    table.innerHTML = "";
                    data.forEach(pedido => {
                        table.innerHTML += `
                            <tr>
                                <td>${pedido.CLIENTE}</td>
                                <td>${pedido.ITEM}</td>
                                <td>${pedido.CANTIDAD} ${pedido.UNIDAD}</td>
                                <td>${pedido.FECHAPEDIDO}</td>
                                <td>${pedido.ENTREGADO}</td>
                                <td>$${pedido.TOTAL}</td>
                            </tr>
                        `;
                    });
                });
                fetch("php/clientesypedidos/SelectBalance.php?ingreso="+encodeURIComponent(0))
                .then(res => res.json())
                .then(data => {
                    let texto = document.getElementById("Ingresos");
                    texto.innerHTML = "";
                    data.forEach(ingreso => {
                        texto.innerHTML = `$${ingreso.TOTAL}`;
                    });
                });
                fetch("php/clientesypedidos/SelectBalance.php?ingreso="+encodeURIComponent(1))
                .then(res => res.json())
                .then(data => {
                    let texto = document.getElementById("Gastos");
                    texto.innerHTML = "";
                    data.forEach(gasto => {
                        texto.innerHTML = `$${gasto.TOTAL}`;
                    });
                });
                fetch("php/clientesypedidos/SelectBalance.php?ingreso="+encodeURIComponent(2))
                .then(res => res.json())
                .then(data => {
                    let texto = document.getElementById("Balance");
                    texto.innerHTML = "";
                    data.forEach(balance => {
                        texto.innerHTML = `$${balance.TOTAL}`;
                        if(balance.TOTAL < 0){
                            texto.style="color:#C51B1B; font-size: 25px; margin-top: 30px;";
                        }
                    });
                });
        }
    </script>
</html>