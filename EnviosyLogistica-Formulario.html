<html>
    <head>
        <title>AgroCaña</title>
        <meta charset="UTF-8">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inder&family=Inter:opsz,wght@14..32,200&display=swap" rel="stylesheet">
        <link rel="icon" type="png" href="iconos/logo.png"/>
        <link rel="stylesheet" href="estilos/formulariosedit.css">
        <script type="text/javascript" src="scripts/sesion.js"></script>
        <style>
            label {
                margin-top: 15px;
                font-weight: bold;
            }
            input[type=submit] {
                margin-top: 20px;
            }
            body {
                margin-top: 30px;
            }
            .centrado {
                display: flex;
                justify-content: space-between;
            }
            .centrado div {
                width: 48%;
                padding-inline: 3px;
            }
            form {
                margin-top: 200px;
                width: 40%;
                padding-top: 30px;
            }
            h1 {
                margin-left: 0px;
            }
            select.invalid {
                outline: 2px solid #e53935;
            }
        </style>
    </head>
    <body onload="inicio()">
        <form action="php/envios/Envios-form.php" method="post" id="formulario">
            <h1>Programar Nuevo Envío</h1><br>
            <h2 style="color: #8B8383;">Programa la entrega</h2>
            <div class="centrado">
                <div>
                    <label for="pedido">Pedido</label><br>
                    <select id="pedido" name="pedido" required>
                        <option disabled selected >Selecciona Pedido</option>
                    </select>
                </div>
                <div>
                    <label for="vehiculo">Vehículo</label><br>
                    <select id="vehiculo" name="vehiculo" required>
                        <option disabled selected>Selecciona Vehículo</option>
                    </select>
                </div>
            </div>
            <div class="centrado">
                <div>
                    <label for="conductor">Conductor</label><br>
                    <select id="conductor" name="conductor" required>
                        <option disabled selected>Selecciona Conductor</option>
                    </select><br>
                </div>
                <div>
                    <label for="costo">Costo</label><br>
                    <input type="number" placeholder="$00.00" id="costo" name="costo" required />
                </div>
            </div>
            <label style="font-size: 18px;">Origen</label><br>
            <div class="centrado">
                <div>
                    <label for="origen-cp">Codigo Postal</label><br>
                    <input type="text" maxlength="5" id="origen-cp" name="origen-cp" placeholder="Ingrese el codigo postal" required onchange="coloniasO()"/>
                </div>
                <div>
                    <label for="origen-colonia">Colonia</label><br>
                    <select id="origen-colonia" name="origen-colonia" required>
                        <option disabled selected>Selecciona colonia</option>
                    </select>
                </div>
                <div>
                    <label for="origen-calle">Calle</label><br>
                    <input type="text" value="AgroCaña Lara" id="origen-calle" maxlength="100" name="origen-calle" required/>
                </div>
            </div>
            <label style="font-size: 18px;">Destino</label><br>
            <div class="centrado">
                <div>
                    <label for="destino-cp">Codigo Postal</label><br>
                    <input type="text" id="destino-cp" name="destino-cp" maxlength="5" placeholder="Ingrese el codigo postal" required onchange="coloniasD()"/>
                </div>
                <div>
                    <label for="destino-colonia">Colonia</label><br>
                    <select id="destino-colonia" name="destino-colonia" required>
                        <option disabled selected>Selecciona colonia</option>
                    </select>
                </div>
                <div>
                    <label for="destino-calle">Calle</label><br>
                    <input type="text" maxlength="100" placeholder="Ingrese el nombre de la calle" id="destino-calle" name="destino-calle" required/>
                </div>
            </div>
            <div class="centrado">
                <div>
                    <label for="salida">Fecha y Hora de salida</label><br>
                    <input type="datetime-local" placeholder="dd/mm/aaaa hh:mm" id="salida" name="salida" required/>
                </div>
                <div>
                    <label for="llegada">Fecha y Hora estimada de llegada</label><br>
                    <input type="datetime-local" placeholder="dd/mm/aaaa hh:mm" id="llegada" name="llegada" required/>
                </div>
            </div>
            <label for="observaciones">Observaciones</label><br>
            <textarea id="observaciones" name="observaciones" placeholder="Notas del Envío" style="size: 100px;" maxlength="100"></textarea><br>
            <div align="center">
                <input type="submit" value="Guardar Envío" id="boton"/>
            </div>
        </form>
    </body>
    <script>
        function inicio() {
            const params = new URLSearchParams(window.location.search);
            const cve = params.get('cve');

            if (cve) {
                document.getElementById('boton').value = "Actualizar";
                fetch('php/envios/SelectEnvios.php?cve=' + encodeURIComponent(cve))
                    .then(res => res.json())
                    .then(data => {
                        console.log(data);
                        if (data && data[0]) {
                            document.getElementById('pedido').value = data[0].NPEDIDO || '';
                            document.getElementById('vehiculo').value = data[0].PLACA || '';
                            document.getElementById('conductor').value = data[0].CVE_CONDUCTOR || '';
                            document.getElementById('costo').value = data[0].COSTO || '';
                            document.getElementById('origen-cp').value = data[0].CPO || '';
                            coloniasO(data[0].CO);
                            document.getElementById('origen-calle').value = data[0].ORIGEN || '';
                            document.getElementById('destino-cp').value = data[0].CPD || '';
                            coloniasD(data[0].CD);
                            document.getElementById('destino-calle').value = data[0].DESTINO || '';
                            document.getElementById('salida').value = data[0].FECHASALIDA || '';
                            document.getElementById('llegada').value = data[0].FECHALLEGADA || '';
                            document.getElementById('observaciones').value = data[0].OBSERVACIONES || '';
                            document.getElementById('formulario').action += '?cve=' + encodeURIComponent(cve);
                        }
                    })
                    .catch(err => console.error('Error cargando cliente:', err));
            }
            fetch("php/envios/SelectConductores.php?cve="+encodeURIComponent(cve))
            .then(res => res.json())
            .then(datos => {
                var select = document.getElementById("conductor");
                datos.forEach(conductor => {
                    const option = document.createElement('option');
                    option.value = conductor.CVE_USUARIO;
                    option.textContent = conductor.NOMBRE + " " + conductor.APELLIDO_P + " " + conductor.APELLIDO_M;
                    select.appendChild(option);
                });
            });
            fetch("php/envios/SelectPedidos.php?cve="+encodeURIComponent(cve))
            .then(res => res.json())
            .then(datos => {
                var select = document.getElementById("pedido");
                datos.forEach(pedido => {
                    const option = document.createElement('option');
                    option.value = pedido.CVE_PEDIDO;
                    option.textContent = pedido.CVE_PEDIDO;
                    select.appendChild(option);
                });
            });
            fetch("php/envios/SelectVehiculos.php")
            .then(res => res.json())
            .then(datos => {
                var select = document.getElementById("vehiculo");
                datos.forEach(pedido => {
                    const option = document.createElement('option');
                    option.value = pedido.PLACA;
                    option.textContent = pedido.PLACA;
                    select.appendChild(option);
                });
            });
            const form = document.querySelector('form');

            form.addEventListener('submit', (e) => {
                const selects = Array.from(form.querySelectorAll('select'));
                const invalid = selects.filter(s => !s.value || s.selectedIndex === 0);

                if (invalid.length) {
                    e.preventDefault();
                    invalid.forEach(s => s.classList.add('invalid'));
                    invalid[0].focus();
                    alert('Por favor selecciona una opción en todos los desplegables antes de enviar.');
                    return false;
                }
            });
            
            document.querySelectorAll('select').forEach(s => {
                s.addEventListener('change', () => s.classList.remove('invalid'));
            });
        }
        function coloniasO(selectedColonia = null) {
            const cp = document.getElementById("origen-cp").value.trim();
            const select = document.getElementById("origen-colonia");
            Array.from(select.options).forEach((opt, idx) => { if (idx !== 0) opt.remove(); });
            if (!cp) return;
            return fetch("php/envios/SelectColonias.php?id=" + encodeURIComponent(cp))
                .then(res => res.json())
                .then(datos => {
                    var select = document.getElementById("origen-colonia");
                    datos.forEach(colonia => {
                        const option = document.createElement('option');
                        option.value = colonia.CVE_COLONIA;
                        option.textContent = colonia.NOMBRE;
                        select.appendChild(option);
                    });
                    if (selectedColonia) {
                        select.value = selectedColonia;
                    }
                });
        }
        function coloniasD(selectedColonia = null) {
            const cp = document.getElementById("destino-cp").value.trim();
            const select = document.getElementById("destino-colonia");
            Array.from(select.options).forEach((opt, idx) => { if (idx !== 0) opt.remove(); });
            if (!cp) return;
            return fetch("php/envios/SelectColonias.php?id=" + encodeURIComponent(cp))
                .then(res => res.json())
                .then(datos => {
                    var select = document.getElementById("destino-colonia");
                    datos.forEach(colonia => {
                        const option = document.createElement('option');
                        option.value = colonia.CVE_COLONIA;
                        option.textContent = colonia.NOMBRE;
                        select.appendChild(option);
                    });
                    if (selectedColonia) {
                        select.value = selectedColonia;
                    }
                });
        }
    </script>
</html>