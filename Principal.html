<html>
<head>
    <title>AgroCaña</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta charset="UTF-8">
    <link rel="icon" type="png" href="iconos/logo.png" />
    <link rel="stylesheet" type="text/css" href="estilos/principal2.css" />
    <script type="text/javascript" src="scripts/sesion.js"></script>
    <style>
    </style>
</head>
<body>
    <div class="titulo">
        <h1>Panel Principal</h1>
        <h2>Resumen general del estado de la produccion</h2>
    </div>
    <div class="contenido">
        <div class="nivel1">
            <div class="grafica">
                <canvas id="ndviChart" ></canvas>
            </div>
            <div class="datos">
                <div class="filtros">
                    <input type="date" id="fechaInicio" class="fecha">
                    <input type="date" id="fechaFin" class="fecha">
                </div>
                <div class="tabla">
                    <div class="ndvi">
                        <div class="tituFrase"><text style="font-size: 20px;">NDVI</text><text id="condicion">Cargando..</text></div>
                        <text style="font-size: 12px; color: gray;" id="fechaNDVI">Fecha</text>
                        <div class="columna"> <text style="color: green;">Max</text><text id="max" >Cargando..</text></div>
                        <div class="columna"><text style="color: red;">Min</text><text id="min">Cargando..</text></div>
                        <div class="columna"><text >Promedio</text><text id="mean">Cargando..</text></div>
                        <div class="columna"><text >Central</text><text id="median">Cargando..</text></div>
                        <div class="columna"><text >Desviación Estándar</text><text id="std">Cargando..</text></div>
                    </div>
                    <div class="etiqueta" style="gap: 20px;">
                        <div class="tituFrase"><text style="font-size: 20px;">Estado del Clima</text></div>
                        <div class="columna" style="gap: 10px;">
                            Ubicacion:
                            <div class="respuesta" id="ubicacion"></div>
                        </div>
                        <div class="columna" style="gap: 10px;">
                            Temperatura:
                            <div class="respuesta" id="temperatura"></div>
                        </div>
                        <div class="columna" style="gap: 10px;">
                            Condición:
                            <div class="respuesta" id="condicionClima"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="nivel2">
            <div class="cultivos" style="height: 100%;">
                <div class="subtitulo">
                    <h3>Cultivos Activos</h3> <img src="iconos/planta2.png" alt="Cultivos Icon" width="15" height="15" />
                </div>
                <p id="ACTIVOS" class="numero">0</p>
                <p class="des2" id="HECTAREAS">0 hectáreas totales</p>
                <p class="cont" style="color: white;">0 En crecimiento</p>
            </div>
            <div class="cosecha" >
                <div class="subtitulo">
                    <h3>Estado de la Cosecha</h3><img src="iconos/palomita1.png" alt="Cosecha Icon" width="13" height="13" />
                </div>
                <p class="numero" id="COSECHA">0</p>
                <p class="des2">Lotes listos para cosechar</p>
                <p class="cont" id="CRECIMIENTO">0 En crecimiento</p>
            </div>
            <div class="finanzas">
                <div class="subtitulo">
                    <h3>Finanzas</h3><img src="iconos/monedas.png" alt="Finanzas Icon" width="13" height="13" />
                </div>
                <p id="balanceMes" class="numero">$0</p>
                <p class="des2">Balance neto del mes</p>
                <div class="detalles">
                    <p class="des" style="color: #346E19;">Ingresos:</p>
                    <p class="des" id="ingresosMes">$0</p>
                </div>
                <div class="detalles">
                    <p class="des" style="color: #FD0000;">Gastos:</p>
                    <p class="des" id="gastosMes">$0</p>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    console.log("JS cargado");
    const apiKey = "ca89717cf429130019ba830342fa1c82";

async function obtenerClima() {
  try {
    const ciudad = "Cardenas"; // puedes cambiarla luego

    const url = `https://api.openweathermap.org/data/2.5/weather?q=${ciudad},mx&units=metric&lang=es&appid=${apiKey}`;

    const respuesta = await fetch(url);
    const datos = await respuesta.json();

    // insertar en tu interfaz
    document.getElementById("ubicacion").textContent = datos.name;
    document.getElementById("temperatura").textContent = datos.main.temp + " °C";
    document.getElementById("condicionClima").textContent = datos.weather[0].description;

  } catch (error) {
    console.error("Error obteniendo clima:", error);
  }
}

document.addEventListener("DOMContentLoaded", obtenerClima);

        fetch("/proyecto/agrocana/php/principal.php?desc=" + encodeURIComponent(0))
        .then(res => res.json())
        .then(data => {
            document.getElementById("ACTIVOS").textContent = data[0].TOTAL;
            document.getElementById("HECTAREAS").textContent = data[0].HECTAREAS + ' hectáreas totales';
        });
    fetch("/proyecto/agrocana/php/principal.php?desc=" + encodeURIComponent(1))
        .then(res => res.json())
        .then(data => {
            document.getElementById("COSECHA").textContent = data[0].TOTAL;
        });
    fetch("/proyecto/agrocana/php/principal.php?desc=" + encodeURIComponent(2))
        .then(res => res.json())
        .then(data => {
            document.getElementById("CRECIMIENTO").textContent = data[0].TOTAL + ' En crecimiento';
        });
    let ingresos = 0;
    let gastos = 0;

    const Ingr = fetch("php/finanzasyrecursos/FinanzasyRecursos_VistaIngreso.php")
        .then(res => res.json())
        .then(data => {
            ingresos = Number(data.totalIngresos);
            document.getElementById("ingresosMes").textContent =
                "$" + ingresos.toLocaleString();
        });
    const Gast = fetch("php/finanzasyrecursos/FinanzasyRecursos_VistaGasto.php")
        .then(res => res.json())
        .then(data => {
            gastos = Number(data.totalGastos);
            document.getElementById("gastosMes").textContent =
                "$" + gastos.toLocaleString();
        });

    Promise.all([Ingr, Gast]).then(() => {
        const balance = ingresos - gastos;

        document.getElementById("balanceMes").textContent =
            "$" + balance.toLocaleString();
        if (balance < 0) {
            document.getElementById("balanceMes").style.color = "#C51B1B";
        } else {
            document.getElementById("balanceMes").style.color = "#346E19";
        }
    });

    const API_KEY = "d25c5faafdfce26b40b38ff1256b924a";
    const FieldID = "699a7909c2d63e950b38df78";

    const fechaInicio = document.getElementById("fechaInicio");
    const fechaFin = document.getElementById("fechaFin");

    let ndviChart;

    function fechaATimestamp(fecha) {
    return Math.floor(new Date(fecha + "T00:00:00").getTime() / 1000);
    }

    function cargarNDVI() {
    if (!fechaInicio.value || !fechaFin.value) return;

    const start = fechaATimestamp(fechaInicio.value);
    const end = fechaATimestamp(fechaFin.value);

fetch(`https://api.agromonitoring.com/agro/1.0/ndvi/history?start=${start}&end=${end}&polyid=${FieldID}&appid=${API_KEY}`)
  .then(res => res.json())
  .then(res => {
    console.log("NDVI histórico:", res);

    if (!Array.isArray(res) || res.length === 0) {
      console.warn("No hay datos NDVI");
      return;
    }

    const ordenado = res.sort((a, b) => a.dt - b.dt);

    const seleccionado = ordenado.reduce((prev, curr) => {
    return Math.abs(curr.dt - end) < Math.abs(prev.dt - end) ? curr : prev;
    });

    const { max, min, mean, median, std } = seleccionado.data;

    document.getElementById('max').textContent = max.toFixed(2);
    document.getElementById('min').textContent = min.toFixed(2);
    document.getElementById('mean').textContent = mean.toFixed(2);
    document.getElementById('median').textContent = median.toFixed(2);
    document.getElementById('std').textContent = std.toFixed(2);


    if (seleccionado.data.mean < 0.2) desc = "Muy poca o nula vegetación";
    else if (seleccionado.data.mean < 0.4) desc = "Vegetación escasa o estresada";
    else if (seleccionado.data.mean < 0.6) desc = "Vegetación moderada y saludable";
    else if (seleccionado.data.mean < 0.8) desc = "Vegetación densa y vigorosa";
    else desc = "Vegetación extremadamente densa";

    document.getElementById('condicion').textContent = desc;
    document.getElementById('fechaNDVI').textContent =
        `Desde ${fechaInicio.value} hasta ${fechaFin.value}`;

    const labels = ordenado.map(i => new Date(i.dt * 1000).toLocaleDateString());
    const valores = ordenado.map(i => i.data.mean);

    const ctx = document.getElementById('ndviChart').getContext('2d');
    if (ndviChart) ndviChart.destroy();
      ndviChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'NDVI promedio',
            data: valores,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          scales: { y: { min: -1, max: 1 } }
        }
      });
    })
    .catch(err => console.error("Error NDVI:", err));
}
        const hoy = new Date();
        const limite = new Date();
        limite.setDate(hoy.getDate() - 5);

        const formatear = f => f.toISOString().split("T")[0];

        fechaInicio.max = formatear(limite);
        fechaFin.max = formatear(limite);

        const now = Math.floor(Date.now() / 1000);
        const fiveDaysAgo = new Date((now - 5 * 86400) * 1000);
        const oneMonthAgo = new Date((now - 30 * 86400) * 1000);

        fechaInicio.value = formatear(oneMonthAgo);
        fechaFin.value = formatear(fiveDaysAgo);

        fechaInicio.addEventListener("change", cargarNDVI);
        fechaFin.addEventListener("change", cargarNDVI);

        cargarNDVI();
</script>
</html>