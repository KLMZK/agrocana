<html>

<head>
    <title>AgroCaña</title>
    <meta charset="UTF-8">
    <link rel="icon" type="png" href="iconos/logo.png" />
    <link rel="stylesheet" type="text/css" href="estilos/principal.css" />
    <script type="text/javascript" src="scripts/sesion.js"></script>
</head>

<body>
    <div class="titulo">
        <h1>Panel Principal</h1>
        <h2>Resumen general del estado de la produccion</h2>
    </div>
    <div class="contenido">
        <div class="nivel1">
            <div class="cultivos">
                <div class="subtitulo">
                    <h3>Cultivos Activos</h3> <img src="iconos/planta2.png" alt="Cultivos Icon" width="15"
                        height="15" />
                </div>
                <p id="ACTIVOS" class="numero">0</p>
                <p class="des2" id="HECTAREAS">0 hectáreas totales</p>
            </div>
            <div class="cosecha">
                <div class="subtitulo">
                    <h3>Estado de la Cosecha</h3><img src="iconos/palomita1.png" alt="Cosecha Icon" width="13"
                        height="13" />
                </div>
                <p class="numero" id="COSECHA">0</p>
                <p class="des2">Lotes listos para cosechar</p>
                <p class="cont" id="CRECIMIENTO">0 En crecimiento</p>
            </div>
            <div class="finanzas">
                <div class="subtitulo">
                    <h3>Finanzas</h3><img src="iconos/monedas.png" alt="Finanzas Icon" width="13" height="13" />
                </div>
                <p id="balanceMes" class="numero">$0</p>
                <p class="des2">Balance neto del mes</p>
                <div class="detalles">
                    <p class="des" style="color: #346E19;">Ingresos:</p>
                    <p class="des" id="ingresosMes">$0</p>
                </div>
                <div class="detalles">
                    <p class="des" style="color: #FD0000;">Gastos:</p>
                    <p class="des" id="gastosMes">$0</p>
                </div>
            </div>
        </div>
        <div class="nivel2">
            <div class="clima">
                <div class="subtitulo">
                    <h3>Estado del Clima</h3><img src="" alt="Clima Icon" width="30" height="30" id="clima-icon" />
                </div>
                <div class="detalles">
                    <p class="des">Ubicación: </p>
                    <div class="estado" style="background-color: transparent; width: 300px">
                        <p class="des" id="ubicacion">Cargando...</p>
                    </div>
                </div>
                <div class="detalles">
                    <p class="des">Temperatura: </p>
                    <div class="estado" style="width: 300px">
                        <p class="des" id="temperatura">-- °C</p>
                    </div>
                </div>
                <div class="detalles">
                    <p class="des">Condición: </p>
                    <div class="estado" style="background-color: transparent; width: 300px">
                        <p class="des" id="condicion">--</p>
                    </div>
                </div>
            </div>
            <div class="actividades">
                <h3>Actividades Recientes</h3>
                <div id="mostraractividades">

                </div>
            </div>
        </div>
        <div class="nivel3">
            <div class="envios">
                <h3>Enviós</h3>
                <div id="mostrarenvios"
                    style="display: flex; align-items: center; justify-content: space-between; height: 70%;"></div>
            </div>
        </div>
    </div>
</body>
<script>
    fetch("/php/principal.php?desc=" + encodeURIComponent(0))
        .then(res => res.json())
        .then(data => {
            document.getElementById("ACTIVOS").textContent = data[0].TOTAL;
            document.getElementById("HECTAREAS").textContent = data[0].HECTAREAS + ' hectáreas totales';
        });
    fetch("/php/principal.php?desc=" + encodeURIComponent(1))
        .then(res => res.json())
        .then(data => {
            document.getElementById("COSECHA").textContent = data[0].TOTAL;
        });
    fetch("/php/principal.php?desc=" + encodeURIComponent(2))
        .then(res => res.json())
        .then(data => {
            document.getElementById("CRECIMIENTO").textContent = data[0].TOTAL + ' En crecimiento';
        });
    let ingresos = 0;
    let gastos = 0;

    const Ingr = fetch("php/finanzasyrecursos/FinanzasyRecursos_VistaIngreso.php")
        .then(res => res.json())
        .then(data => {
            ingresos = Number(data.totalIngresos);
            document.getElementById("ingresosMes").textContent =
                "$" + ingresos.toLocaleString();
        });
    const Gast = fetch("php/finanzasyrecursos/FinanzasyRecursos_VistaGasto.php")
        .then(res => res.json())
        .then(data => {
            gastos = Number(data.totalGastos);
            document.getElementById("gastosMes").textContent =
                "$" + gastos.toLocaleString();
        });

    Promise.all([Ingr, Gast]).then(() => {
        const balance = ingresos - gastos;

        document.getElementById("balanceMes").textContent =
            "$" + balance.toLocaleString();
        if (balance < 0) {
            document.getElementById("balanceMes").style.color = "#C51B1B";
        } else {
            document.getElementById("balanceMes").style.color = "#346E19";
        }
    });
    const apiKey = '25c1005ad5f6470adc5c5f0876d798c6';
    const lat = 18.0029214582026;
    const lon = -93.4959150193584;
    const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=es`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.cod === 200) {
                const temp = Math.round(data.main.temp);
                const desc = data.weather[0].description;
                const iconCode = data.weather[0].icon;
                const city = data.name;

                document.getElementById('temperatura').textContent = `${temp}°C`;
                document.getElementById('condicion').textContent = desc.charAt(0).toUpperCase() + desc.slice(1);
                document.getElementById('ubicacion').textContent = city;
                document.getElementById('clima-icon').src = `https://openweathermap.org/img/wn/${iconCode}.png`;
            } else {
                console.error('Error fetching weather:', data.message);
            }
        })
        .catch(error => console.error('Error:', error));

    fetch("/php/principal.php?desc=" + encodeURIComponent(5))
        .then(res => res.json())
        .then(data => {
            const div = document.getElementById("mostraractividades");
            div.innerHTML = '';
            for (var i = 0; i < 2; i++) {
                div.innerHTML += `
                    <div class="actividad">
                        <div>
                            <p class="des">${data[i].TIPO}</p>
                            <p class="des2">${data[i].NOMBRE} ${data[i].APELLIDOP} ${data[i].APELLIDOM} ${data[i].FECHA}</p>
                        </div>
                        <div class="estado" ${data[i].ESTADO == 'Pendiente' ? 'style="background-color:transparent;"' : ''}>
                            <p class="des" id="riego"> ${data[i].ESTADO}</p>
                        </div>
                    </div>
                `
            }
        });
    fetch("/php/principal.php?desc=" + encodeURIComponent(6))
        .then(res => res.json())
        .then(data => {
            const div = document.getElementById("mostrarenvios");
            div.innerHTML = '';
            for (var i = 0; i < 3; i++) {
                div.innerHTML += `
                    <div class="envio">
                        <p id="cliente">${data[i].CLIENTE}</p>
                        <div align="center">
                            <p class="des" id="envio-fecha" style="margin-bottom:15px;">${data[i].FECHASALIDA}</p>
                            <div class="estado" ${data[i].ENTREGADO == '0' ? 'style="background-color:transparent;"' : ''}>
                                <p class="des" id="envio-estado">${data[i].ENTREGADO == '0' ? 'En transito' : 'Entregado'}</p>
                            </div>
                            <p class="des2" style="margin-top:13px;">${data[i].ITEM} ${data[i].CANTIDAD} ${data[i].UNIDAD}</p>
                        </div>
                    </div>
                `
            }
        });
</script>

</html>