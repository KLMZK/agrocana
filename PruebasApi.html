<!DOCTYPE html>
<html>
  <head>
    <title>NDVI últimos días</title>
    <meta charset="utf-8" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      #ndviChart { max-width: 50%; }
      #imgSat { max-width: 50%; }
    </style>
  </head>
  <body>

    <h3>NDVI histórico (del último mes hasta hace 4 días)</h3>
    <canvas id="ndviChart" height="120"></canvas>

    <h3>NDVI imagen más reciente en el rango</h3>
    <img id="imgSat" />

    <script>
      const API_KEY = "d25c5faafdfce26b40b38ff1256b924a";
      const FieldID = "699a7909c2d63e950b38df78";

    
      const now = Math.floor(Date.now() / 1000);              
      const fourDaysAgo = now - (4 * 24 * 60 * 60);           
      const oneMonthAgo = now - (30 * 24 * 60 * 60);          

      const start = oneMonthAgo;   
      const end   = fourDaysAgo;   

      // 1) NDVI histórico para la gráfica
      fetch(`https://api.agromonitoring.com/agro/1.0/ndvi/history?start=${start}&end=${end}&polyid=${FieldID}&appid=${API_KEY}`)
        .then(res => res.json())
        .then(data => {
          console.log("NDVI histórico:", data);


          if (!data || !data.length) {
            console.warn("No hay datos NDVI en ese rango");
            return;
          }

          // Limpiar y ordenar
          const limpio = data
            .filter(d => d.data && d.data.mean != null)
            .sort((a, b) => a.dt - b.dt);

          const labels = limpio.map(item => {
            const fecha = new Date(item.dt * 1000);
            return fecha.toLocaleDateString();
          });

          const valores = limpio.map(item => item.data.mean);

          const ctx = document.getElementById('ndviChart').getContext('2d');
          new Chart(ctx, {
            type: 'line',
            data: {
              labels,
              datasets: [{
                label: 'NDVI promedio',
                data: valores,
                tension: 0.3
              }]
            },
            options: {
              scales: {
                y: { min: -1, max: 1, title: { display: true, text: 'NDVI' } }
              }
            }
          });
        })
        .catch(err => console.error("Error NDVI:", err));

        fetch(`http://api.agromonitoring.com/agro/1.0/soil?polyid=${FieldID}&appid=${API_KEY}`)
        .then(res => res.json())
        .then(data => {
          console.log("Respuesta:", data);
        })
    

      // 2) Imagen NDVI más reciente dentro del rango
      fetch(`http://api.agromonitoring.com/agro/1.0/image/search?start=${start}&end=${end}&polyid=${FieldID}&appid=${API_KEY}`) 
        .then(res => res.json()) 
        .then(data => { 
            const urlImagen = data[0].image.ndvi; document.getElementById("imgSat").src = urlImagen; 
            
        });
        
    </script>
  </body>
</html>